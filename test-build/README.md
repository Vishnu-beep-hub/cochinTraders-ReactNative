# Cochin Traders App (Expo React Native)

This is the mobile client for Cochin Traders, built with Expo React Native. It connects to the companion desktop backend “Cochin Connect” (Electron + Node.js) through a public URL provided by ngrok. The mobile app reads that public URL from environment variables and uses it as the API base.

## Overview

- Mobile client: Expo React Native app with typed routing and splash-gate onboarding.
- Backend: Electron + Node.js app (“Cochin Connect”) serving HTTP on `localhost:3000`.
- Connectivity: ngrok exposes `localhost:3000` as a public HTTPS URL. The app uses `BASE_URL` from `.env` to call backend APIs.
- Data: Company, parties, stocks and trader activities are fetched from the backend.

## Architecture

- Frontend (this repo)
  - Expo Router screens and components
  - AsyncStorage-based employee name gate with a splash overlay
  - Location + geocoding (primary `react-native-geocoder`, fallback OpenStreetMap, then Expo Location)
  - UI elements for shop selection, cart, receivables, stocks
- Backend (Cochin Connect)
  - Electron shell running a Node.js server on `http://localhost:3000`
  - ngrok publishes the local server to a public URL used by the app

Key integration points:
- API base URL resolution in the app is driven by `process.env.BASE_URL`. See [api.ts](file:///p:/Cochin%20Tirur/cochin-traders-app/lib/api.ts).
- Splash-gate behavior and employee storage logic are in [app/_layout.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/app/_layout.tsx) and [AnimatedSplash.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/components/AnimatedSplash.tsx).
- Punch-in activity payload posting is implemented in [dashboard.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/app/(tabs)/dashboard.tsx) and uses `postTraderActivity` from [api.ts](file:///p:/Cochin%20Tirur/cochin-traders-app/lib/api.ts).
- Cart order submission endpoint constant is in [cart.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/app/cart.tsx) (adjust if needed to match `BASE_URL`).

## Prerequisites

- Node.js 18+ and npm
- Expo CLI (`npm i -g expo-cli`) or use `npx expo`
- ngrok (v3+)
- The Cochin Connect Electron app installed and able to start a local Node server on port 3000
- Android Studio or Xcode if building for devices/emulators

## Setup

1. Start Cochin Connect (Electron + Node) and confirm it serves `http://localhost:3000`.
2. Start ngrok to expose your local server:

   ```bash
   ngrok http 3000
   ```

   Copy the public HTTPS URL generated by ngrok (e.g. `https://<subdomain>.ngrok.app`).

3. In this repo, create a `.env` file with:

   ```
   BASE_URL=https://<subdomain>.ngrok.app/api
   ADMIN_PIN=3133
   ```

   - `BASE_URL` must point to the `/api` path of the ngrok URL.
   - `ADMIN_PIN` is forwarded with requests; align it with backend expectations.

4. Install dependencies and run the app:

   ```bash
   npm install
   npm run start
   ```

5. Launch on your target:
   - Android: `npm run android`
   - iOS: `npm run ios`
   - Web: `npm run web`

## Environment Variables

- `BASE_URL`: Public API base provided by ngrok (required). Used by API helpers in [api.ts](file:///p:/Cochin%20Tirur/cochin-traders-app/lib/api.ts).
- `ADMIN_PIN`: Admin PIN header value appended to API calls; must match backend configuration.

Note: `.env` files are ignored by `.gitignore` and should not be committed.

## Important Flows

- Employee gate and splash:
  - On app open, a splash runs for ~3 seconds. If an employee name does not exist in local storage, the app keeps the splash and shows a blurred input overlay. Logic: [app/_layout.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/app/_layout.tsx), [AnimatedSplash.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/components/AnimatedSplash.tsx).
- Shop name suggestions:
  - Absolute-positioned dropdown with z-index for visibility, limit to 5 items; shared input component: [ShopInput.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/components/trader/ShopInput.tsx).
- Outstanding page:
  - Shows Address, Parent, and Cr/Dr based on closing balance: [outstanding.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/app/(tabs)/outstanding.tsx).
- Punch-in API payload:
  - Sends employee name, shop name, amount, date, time, and place to backend: [dashboard.tsx](file:///p:/Cochin%20Tirur/cochin-traders-app/app/(tabs)/dashboard.tsx) using [postTraderActivity](file:///p:/Cochin%20Tirur/cochin-traders-app/lib/api.ts#L1-L99).

## Development Workflow

- Update `BASE_URL` whenever ngrok restarts or the public URL changes.
- Ensure Cochin Connect is running before opening the app; the client expects an active backend.
- Use Expo’s dev tools to run on device/emulator and debug UI/layout.

## Security and Git Hygiene

- `.env` and `.env*.local` are ignored by Git; do not commit secrets.
- Private keys, keystores, and native build outputs are ignored.
- Additional ignores for logs, coverage, caches, and editor metadata are configured in [.gitignore](file:///p:/Cochin%20Tirur/cochin-traders-app/.gitignore).

## Troubleshooting

- Backend unreachable:
  - Confirm Electron app is serving `localhost:3000`.
  - Verify ngrok is running and the URL in `.env` is correct.
  - Check device network access to the ngrok domain.
- Admin PIN errors:
  - Align `ADMIN_PIN` in `.env` with backend validation.
- Location/address issues:
  - Ensure location permissions are granted.
  - Geocoding falls back to OpenStreetMap and Expo Location if native lookup fails.

## Scripts

See [package.json](file:///p:/Cochin%20Tirur/cochin-traders-app/package.json) for available scripts:

- `start`: Expo dev server
- `android` / `ios` / `web`: Platform-specific launchers
- `tally-server`: Placeholder for a local Node script if needed (ensure `server.js` exists if you use it)

